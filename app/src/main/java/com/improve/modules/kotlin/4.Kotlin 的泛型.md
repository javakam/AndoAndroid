### 4. Kotlin çš„æ³›å‹

<https://kaixue.io/kotlin-generics/>

<https://www.bilibili.com/video/av66340216>

#### ? extends
? extends å«åšã€Œä¸Šç•Œé€šé…ç¬¦ã€ï¼Œå¯ä»¥ä½¿ Java æ³›å‹å…·æœ‰ã€Œåå˜æ€§ Covarianceã€ï¼Œåå˜å°±æ˜¯å…è®¸ä¸Šé¢çš„èµ‹å€¼æ˜¯åˆæ³•çš„ã€‚
```
â˜•ï¸
TextView textView = new Button(context);
// ğŸ‘† è¿™æ˜¯å¤šæ€
â€‹
List<Button> buttons = new ArrayList<Button>();
List<TextView> textViews = buttons;
// ğŸ‘† å¤šæ€ç”¨åœ¨è¿™é‡Œä¼šæŠ¥é”™ incompatible types: List<Button> cannot be converted to List<TextView>
```
Javaä¸­çš„è§£å†³æ–¹æ³•:
```
â˜•ï¸
List<Button> buttons = new ArrayList<Button>();
      ğŸ‘‡
List<? extends TextView> textViews = buttons;
```
è¿™ä¸ª ? extends å«åšã€Œä¸Šç•Œé€šé…ç¬¦ã€ï¼Œå¯ä»¥ä½¿ Java æ³›å‹å…·æœ‰ã€Œåå˜æ€§ Covarianceã€ï¼Œåå˜å°±æ˜¯å…è®¸ä¸Šé¢çš„èµ‹å€¼æ˜¯åˆæ³•çš„ã€‚

```
â˜•ï¸
List<? extends TextView> textViews = new ArrayList<TextView>(); // ğŸ‘ˆ æœ¬èº«
List<? extends TextView> textViews = new ArrayList<Button>(); // ğŸ‘ˆ ç›´æ¥å­ç±»
List<? extends TextView> textViews = new ArrayList<RadioButton>(); // ğŸ‘ˆ é—´æ¥å­ç±»
```
ä½¿ç”¨ ä¸Šç•Œé€šé…ç¬¦ ä¹‹åï¼ŒList çš„ä½¿ç”¨ä¸Šçš„é—®é¢˜ï¼š
```
â˜•ï¸
List<? extends TextView> textViews = new ArrayList<Button>();
TextView textView = textViews.get(0); // ğŸ‘ˆ get å¯ä»¥
textViews.add(textView);
//             ğŸ‘† add ä¼šæŠ¥é”™ï¼Œno suitable method found for add(TextView)
```
æŠŠTextViewæ”¹æˆ"?"å‘¢:<br>
è¿™æ ·ä½¿ç”¨ List<?> å…¶å®æ˜¯ List<? extends Object> çš„ç¼©å†™ã€‚
```
List<Button> buttons = new ArrayList<>();
â€‹
List<?> list = buttons;
Object obj = list.get(0);
â€‹
list.add(obj); // ğŸ‘ˆ è¿™é‡Œè¿˜æ˜¯ä¼šæŠ¥é”™
```
ç”±äº add çš„è¿™ä¸ªé™åˆ¶ï¼Œä½¿ç”¨äº† ? extends æ³›å‹é€šé…ç¬¦çš„ Listï¼Œåªèƒ½å¤Ÿå‘å¤–æä¾›æ•°æ®è¢«æ¶ˆè´¹ï¼Œ
ä»è¿™ä¸ªè§’åº¦æ¥è®²ï¼Œå‘å¤–æä¾›æ•°æ®çš„ä¸€æ–¹ç§°ä¸ºã€Œç”Ÿäº§è€… Producerã€ã€‚å¯¹åº”çš„è¿˜æœ‰ä¸€ä¸ªæ¦‚å¿µå«ã€Œæ¶ˆè´¹è€… Consumerã€ï¼Œå¯¹åº” Java é‡Œé¢å¦ä¸€ä¸ªæ³›å‹é€šé…ç¬¦ ? superã€‚

#### ? super
? super å«åšã€Œä¸‹ç•Œé€šé…ç¬¦ã€ï¼Œå¯ä»¥ä½¿ Java æ³›å‹å…·æœ‰ã€Œé€†å˜æ€§ Contravarianceã€ã€‚
```
â˜•ï¸
List<? super Button> buttons = new ArrayList<Button>(); // ğŸ‘ˆ æœ¬èº«
List<? super Button> buttons = new ArrayList<TextView>(); // ğŸ‘ˆ ç›´æ¥çˆ¶ç±»
List<? super Button> buttons = new ArrayList<Object>(); // ğŸ‘ˆ é—´æ¥çˆ¶ç±»
```
get & set :
```
â˜•ï¸
List<? super Button> buttons = new ArrayList<TextView>();
Object object = buttons.get(0); // ğŸ‘ˆ get å‡ºæ¥çš„æ˜¯ Object ç±»å‹
Button button = ...
buttons.add(button); // ğŸ‘ˆ add æ“ä½œæ˜¯å¯ä»¥çš„
```

> å°ç»“ï¼ŒJava çš„æ³›å‹æœ¬èº«æ˜¯ä¸æ”¯æŒåå˜å’Œé€†å˜çš„ 

- å¯ä»¥ä½¿ç”¨æ³›å‹é€šé…ç¬¦ ? extends æ¥ä½¿æ³›å‹æ”¯æŒåå˜ï¼Œä½†æ˜¯ã€Œåªèƒ½è¯»å–ä¸èƒ½ä¿®æ”¹ã€ï¼Œè¿™é‡Œçš„ä¿®æ”¹ä»…æŒ‡å¯¹æ³›å‹é›†åˆæ·»åŠ å…ƒç´ ï¼Œå¦‚æœæ˜¯ remove(int index) ä»¥åŠ clear å½“ç„¶æ˜¯å¯ä»¥çš„ã€‚
- å¯ä»¥ä½¿ç”¨æ³›å‹é€šé…ç¬¦ ? super æ¥ä½¿æ³›å‹æ”¯æŒé€†å˜ï¼Œä½†æ˜¯ã€Œåªèƒ½ä¿®æ”¹ä¸èƒ½è¯»å–ã€ï¼Œè¿™é‡Œè¯´çš„ä¸èƒ½è¯»å–æ˜¯æŒ‡ä¸èƒ½æŒ‰ç…§æ³›å‹ç±»å‹è¯»å–ï¼Œä½ å¦‚æœæŒ‰ç…§ Object è¯»å‡ºæ¥å†å¼ºè½¬å½“ç„¶ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚

æ ¹æ®å‰é¢çš„è¯´æ³•ï¼Œè¿™è¢«ç§°ä¸º PECS æ³•åˆ™ï¼šã€ŒProducer-Extends, Consumer-Superã€ã€‚

#### Kotlin ä¸­çš„ out å’Œ in

- ä½¿ç”¨å…³é”®å­— out æ¥æ”¯æŒåå˜ï¼Œç­‰åŒäº Java ä¸­çš„ä¸Šç•Œé€šé…ç¬¦ ? extendsã€‚
- ä½¿ç”¨å…³é”®å­— in æ¥æ”¯æŒé€†å˜ï¼Œç­‰åŒäº Java ä¸­çš„ä¸‹ç•Œé€šé…ç¬¦ ? superã€‚
```
ğŸï¸
var textViews: List<out TextView>
var textViews: List<in TextView>
```
æ¢äº†ä¸ªå†™æ³•ï¼Œä½†ä½œç”¨æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚<br>
out è¡¨ç¤ºï¼Œæˆ‘è¿™ä¸ªå˜é‡æˆ–è€…å‚æ•°åªç”¨æ¥è¾“å‡ºï¼Œä¸ç”¨æ¥è¾“å…¥ï¼Œä½ åªèƒ½è¯»æˆ‘ä¸èƒ½å†™æˆ‘ï¼›<br>
in å°±åè¿‡æ¥ï¼Œè¡¨ç¤ºå®ƒåªç”¨æ¥è¾“å…¥ï¼Œä¸ç”¨æ¥è¾“å‡ºï¼Œä½ åªèƒ½å†™æˆ‘ä¸èƒ½è¯»æˆ‘ã€‚
<br><br>

æ³›å‹åœ¨éé›†åˆç±»çš„ä½¿ç”¨ä¹Ÿéå¸¸å¹¿æ³›ï¼Œå°±ä»¥ã€Œç”Ÿäº§è€…-æ¶ˆè´¹è€…ã€ä¸ºä¾‹å­ï¼š
```
class Producer<T> {
    fun produce(): T {
        ...
    }
}
â€‹
val producer: Producer<out TextView> = Producer<Button>()
val textView: TextView = producer.produce() // ğŸ‘ˆ ç›¸å½“äº 'List' çš„ `get`
```
å†æ¥çœ‹çœ‹æ¶ˆè´¹è€…ï¼š
```
ğŸï¸            
class Consumer<T> {
    fun consume(t: T) {
        ...
    }
}
â€‹
val consumer: Consumer<in Button> = Consumer<TextView>()
consumer.consume(Button(context)) // ğŸ‘ˆ ç›¸å½“äº 'List' çš„ 'add'
```

##### å£°æ˜å¤„çš„ out å’Œ in

Kotlin æä¾›äº†å¦å¤–ä¸€ç§å†™æ³•ï¼šå¯ä»¥åœ¨å£°æ˜ç±»çš„æ—¶å€™ï¼Œç»™æ³›å‹ç¬¦å·åŠ ä¸Š out å…³é”®å­—ï¼Œè¡¨æ˜æ³›å‹å‚æ•° T åªä¼šç”¨æ¥è¾“å‡ºï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™å°±ä¸ç”¨é¢å¤–åŠ   out äº†ã€‚
```
ğŸï¸             ğŸ‘‡
class Producer<out T> {
    fun produce(): T {
        ...
    }
}
â€‹
val producer: Producer<TextView> = Producer<Button>() // ğŸ‘ˆ è¿™é‡Œä¸å†™ out ä¹Ÿä¸ä¼šæŠ¥é”™
val producer: Producer<out TextView> = Producer<Button>() // ğŸ‘ˆ out å¯ä»¥ä½†æ²¡å¿…è¦
```
åŒç†ï¼Œç»™æ³›å‹å‚æ•°åŠ ä¸Š in å…³é”®å­—ï¼Œæ¥è¡¨æ˜è¿™ä¸ªæ³›å‹å‚æ•° T åªç”¨æ¥è¾“å…¥ã€‚
```
ğŸï¸            ğŸ‘‡
class Consumer<in T> {
    fun consume(t: T) {
        ...
    }
}
â€‹
val consumer: Consumer<Button> = Consumer<TextView>() // ğŸ‘ˆ è¿™é‡Œä¸å†™ in ä¹Ÿä¸ä¼šæŠ¥é”™
val consumer: Consumer<in Button> = Consumer<TextView>() // ğŸ‘ˆ in å¯ä»¥ä½†æ²¡å¿…è¦
```

##### * å·
å‰é¢è®²åˆ°äº† Java ä¸­å•ä¸ª ? å·ä¹Ÿèƒ½ä½œä¸ºæ³›å‹é€šé…ç¬¦ä½¿ç”¨ï¼Œç›¸å½“äº ? extends Objectã€‚ å®ƒåœ¨ Kotlin ä¸­æœ‰ç­‰æ•ˆçš„å†™æ³•ï¼š* å·ï¼Œç›¸å½“äº  out Anyã€‚
```
ğŸï¸            ğŸ‘‡
var list: List<*>
å’Œ Java ä¸åŒçš„åœ°æ–¹æ˜¯ï¼Œå¦‚æœä½ çš„ç±»å‹å®šä¹‰é‡Œå·²ç»æœ‰äº† out æˆ–è€… inï¼Œé‚£è¿™ä¸ªé™åˆ¶åœ¨å˜é‡å£°æ˜æ—¶ä¹Ÿä¾ç„¶åœ¨ï¼Œä¸ä¼šè¢« * å·å»æ‰ã€‚

æ¯”å¦‚ä½ çš„ç±»å‹å®šä¹‰é‡Œæ˜¯ out T : Number çš„ï¼Œé‚£å®ƒåŠ ä¸Š <*> ä¹‹åçš„æ•ˆæœå°±ä¸æ˜¯ out Anyï¼Œè€Œæ˜¯ out Numberã€‚
```

##### where å…³é”®å­—
Java ä¸­å£°æ˜ç±»æˆ–æ¥å£çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ extends æ¥è®¾ç½®è¾¹ç•Œï¼Œå°†æ³›å‹ç±»å‹å‚æ•°é™åˆ¶ä¸ºæŸä¸ªç±»å‹çš„å­é›†ï¼š
```
â˜•ï¸                
//                ğŸ‘‡  T çš„ç±»å‹å¿…é¡»æ˜¯ Animal çš„å­ç±»å‹
class Monster<T extends Animal>{
}
```

```
//                            ğŸ‘‡  T çš„ç±»å‹å¿…é¡»åŒæ—¶æ˜¯ Animal å’Œ Food çš„å­ç±»å‹
class Monster<T extends Animal & Food>{ 
}
```

Kotlin åªæ˜¯æŠŠ extends æ¢æˆäº† : å†’å·ã€‚
```
ğŸï¸             ğŸ‘‡
class Monster<T : Animal>
```
è®¾ç½®å¤šä¸ªè¾¹ç•Œå¯ä»¥ä½¿ç”¨ where å…³é”®å­—ï¼š
```
ğŸï¸                ğŸ‘‡
class Monster<T> where T : Animal, T : Food
```
Monster æœ¬èº«è¿˜æœ‰ç»§æ‰¿çš„æ—¶å€™ï¼š
```
ğŸï¸
class Monster<T> : MonsterParent<T> where T : Animal
```

##### reified å…³é”®å­—
ç”±äº Java ä¸­çš„æ³›å‹å­˜åœ¨ç±»å‹æ“¦é™¤çš„æƒ…å†µï¼Œä»»ä½•åœ¨è¿è¡Œæ—¶éœ€è¦çŸ¥é“æ³›å‹ç¡®åˆ‡ç±»å‹ä¿¡æ¯çš„æ“ä½œéƒ½æ²¡æ³•ç”¨äº†ã€‚

æ¯”å¦‚ä½ ä¸èƒ½æ£€æŸ¥ä¸€ä¸ªå¯¹è±¡æ˜¯å¦ä¸ºæ³›å‹ç±»å‹ T çš„å®ä¾‹ï¼š
```
â˜•ï¸
<T> void printIfTypeMatch(Object item) {
    if (item instanceof T) { // ğŸ‘ˆ IDE ä¼šæç¤ºé”™è¯¯ï¼Œillegal generic type for instanceof
        System.out.println(item);
    }
}
```
Kotlin é‡ŒåŒæ ·ä¹Ÿä¸è¡Œï¼š
```
ğŸï¸
fun <T> printIfTypeMatch(item: Any) {
    if (item is T) { // ğŸ‘ˆ IDE ä¼šæç¤ºé”™è¯¯ï¼ŒCannot check for instance of erased type: T
        println(item)
    }
}
```
â™¥ è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ Java ä¸­çš„è§£å†³æ–¹æ¡ˆé€šå¸¸æ˜¯é¢å¤–ä¼ é€’ä¸€ä¸ª Class<T> ç±»å‹çš„å‚æ•°ï¼Œç„¶åé€šè¿‡ Class#isInstance æ–¹æ³•æ¥æ£€æŸ¥ï¼š
```
â˜•ï¸                             ğŸ‘‡
<T> void check(Object item, Class<T> type) {
    if (type.isInstance(item)) {
               ğŸ‘†
        System.out.println(item);
    }
}
```
â™¥ Kotlin ä¸­åŒæ ·å¯ä»¥è¿™ä¹ˆè§£å†³ï¼Œä¸è¿‡è¿˜æœ‰ä¸€ä¸ªæ›´æ–¹ä¾¿çš„åšæ³•ï¼šä½¿ç”¨å…³é”®å­— reified é…åˆ inline æ¥è§£å†³ï¼š
```
ğŸï¸ ğŸ‘‡         ğŸ‘‡
inline fun <reified T> printIfTypeMatch(item: Any) {
    if (item is T) { // ğŸ‘ˆ è¿™é‡Œå°±ä¸ä¼šåœ¨æç¤ºé”™è¯¯äº†
        println(item)
    }
}
```












